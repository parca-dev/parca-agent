FROM golang:1.18.3-bullseye

RUN echo "\
deb http://snapshot.debian.org/archive/debian/20220420T025302Z bullseye main\n\
deb http://snapshot.debian.org/archive/debian/20220420T025302Z bullseye-updates main\n\
deb http://snapshot.debian.org/archive/debian/20220420T025302Z bullseye-backports main\n\
deb http://snapshot.debian.org/archive/debian-security/20220420T025302Z bullseye-security main\n\
" > /etc/apt/sources.list

RUN wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -

RUN echo "deb http://apt.llvm.org/bullseye/ llvm-toolchain-bullseye-14 main\n" > /etc/apt/sources.list.d/llvm.list

RUN apt-get -o Acquire::Check-Valid-Until="false" update -y && \
     apt-get install --no-install-recommends -yq llvm-14-dev libclang-14-dev clang-14 make gcc coreutils elfutils binutils zlib1g-dev libelf-dev ca-certificates netbase && \
     ln -s /usr/bin/clang-14 /usr/bin/clang && \
     ln -s /usr/bin/llc-14 /usr/bin/llc


WORKDIR /app

# Install Rust
COPY rust-toolchain.toml /app
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --profile minimal --default-toolchain none -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup component add clippy


COPY go.mod go.sum /app/
RUN go mod download -modcacherw

COPY Makefile ./
COPY 3rdparty ./3rdparty
COPY bpf ./bpf
RUN make -C bpf setup
RUN make bpf

RUN go install github.com/go-delve/delve/cmd/dlv@v1.8.2

COPY . /app
RUN make build

RUN cp /app/dist/parca-agent /bin/parca-agent
RUN cp /go/bin/dlv /dlv

RUN mkdir -p /tmp

EXPOSE 7071

ENTRYPOINT ["/dlv", "--listen=:40000", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "--continue", "--"]
